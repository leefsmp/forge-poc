(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{309:function(e,t,i){"use strict";i.r(t);var r=i(432);t.default=r.a},400:function(e,t,i){e.exports=i.p+"a91f7a1f684a8cae1c93a3e15fda6826.png"},432:function(e,t,i){"use strict";(function(e){i.d(t,"a",function(){return v});var r=i(4),n=i(5),a=i(8),s=i(7),o=i(9),u=i(2),l=i(30),d=i(400),p=i.n(d),c=i(46),v=function(t){function i(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object(r.a)(this,i),(t=Object(a.a)(this,Object(s.a)(i).call(this))).onCameraChanged=t.onCameraChanged.bind(Object(u.a)(Object(u.a)(t))),t.onVisibility=t.onVisibility.bind(Object(u.a)(Object(u.a)(t))),t.onExplode=t.onExplode.bind(Object(u.a)(Object(u.a)(t))),t.viewer=e,t.dbIds=t.getAllDbIds(),t.eventHandlers=[{event:Autodesk.Viewing.EXPLODE_CHANGE_EVENT,handler:t.onExplode},{event:Autodesk.Viewing.CAMERA_CHANGE_EVENT,handler:t.onCameraChanged},{event:Autodesk.Viewing.ISOLATE_EVENT,handler:t.onVisibility},{event:Autodesk.Viewing.HIDE_EVENT,handler:t.onVisibility},{event:Autodesk.Viewing.SHOW_EVENT,handler:t.onVisibility}],t.eventHandlers.forEach(function(e){t.viewer.addEventListener(e.event,e.handler)}),t.geometry=new THREE.Geometry;for(var o=n.maxPoints||1e4,l=0;l<o;++l)t.geometry.vertices.push(new THREE.Vector3);return t.shader=t.createShader(n),t.pointCloud=new THREE.PointCloud(t.geometry,t.shader.material),t.pointCloud.frustumCulled=!1,t.viewer.impl.sceneAfter.add(t.pointCloud),t.options=n,t.markups=[],t}return Object(o.a)(i,t),Object(n.a)(i,[{key:"createShader",value:function(e){var t=e.vertexShader||"\n      attribute float pointSize;\n      attribute vec4 color;\n      varying vec4 vColor;\n      void main() {\n        vec4 vPosition = modelViewMatrix * vec4(position, 1.0);\n        gl_Position = projectionMatrix * vPosition;\n        gl_PointSize = pointSize;\n        vColor = color;\n      }\n    ",i=e.fragmentShader||"\n      uniform sampler2D texture;\n      varying vec4 vColor;\n      void main() {\n        vec4 tex = texture2D(texture, gl_PointCoord);\n        if (tex.a < 0.2) discard;\n        if (vColor.a == 0.0) {\n          gl_FragColor = vec4(tex.r, tex.g, tex.b, tex.a);\n        } else {\n          gl_FragColor = vColor;\n        }\n      }\n    ",r=e.texture||p.a,n=e.shaderParams||{side:THREE.DoubleSide,depthWrite:!1,depthTest:!1,fragmentShader:i,vertexShader:t,opacity:.5,attributes:{pointSize:{type:"f",value:[]},color:{type:"v4",value:[]}},uniforms:{texture:{value:THREE.ImageUtils.loadTexture(r),type:"t"}}},a=new THREE.ShaderMaterial(n),s=new c.a,o=0;return{setTexture:function(e){var t=n.uniforms.texture;t.value=THREE.ImageUtils.loadTexture(e),t.needsUpdate=!0},update:function(){var e=.001*s.getElapsedMs();o=(o+=.25*e)>.5?0:o;var t=n.uniforms.texture;t.value=function(e,t){for(var i=[],r=0;r<e;++r)for(var n=0;n<e;++n){var a=Math.sqrt((r/e-.5)*(r/e-.5)+(n/e-.5)*(n/e-.5));a<.1?i.push(255,0,0,255):a<t-.05?i.push(255,0,0,0):a<t?i.push(255,0,0,255):i.push(0,0,0,0)}var s=new THREE.DataTexture(Uint8Array.from(i),e,e,THREE.RGBAFormat,THREE.UnsignedByteType,THREE.UVMapping);return s.minFilter=THREE.NearestFilter,s.magFilter=THREE.NearestFilter,s.needsUpdate=!0,s}(96,o),t.needsUpdate=!0},material:a}}},{key:"startAnimation",value:function(){var e=this;this.markups.forEach(function(t){e.setMarkupColor(t.id,t.color)}),this.viewer.impl.invalidate(!0),this.runAnimation=!0}},{key:"stopAnimation",value:function(){var e=this,t=this.options.texture||p.a;this.shader.setTexture(t),this.markups.forEach(function(t){e.setMarkupColor(t.id,new THREE.Vector4(0,0,0,0),!0)}),this.viewer.impl.invalidate(!0),this.runAnimation=!1}},{key:"update",value:function(e){this.shader.update(e),this.viewer.impl.invalidate(!1,!0,!1)}},{key:"getMarkupById",value:function(e){var t=this.markups.filter(function(t){return t.id===e});return t.length?t[0]:null}},{key:"setMarkupSize",value:function(e,t,i){var r=this.pointCloud.material.attributes.pointSize,n=this.getMarkupById(e),a=n.visible&&n.__visible;i?r.value[n.index]=t:a&&(n.occlusion&&this.checkOcclusion(n)||(r.value[n.index]=t)),n.size=i?n.size:t,r.needsUpdate=!0,this.viewer.impl.invalidate(!0)}},{key:"setMarkupColor",value:function(e,t,i){var r=this.pointCloud.material.attributes.color,n=this.getMarkupById(e);r.value[n.index]=t,n.color=i?n.color:t,r.needsUpdate=!0,this.viewer.impl.invalidate(!0)}},{key:"getFragmentPos",value:function(e){var t=this.viewer.impl.getRenderProxy(this.viewer.model,e),i=new THREE.Vector3;return i.setFromMatrixPosition(t.matrixWorld),i}},{key:"addMarkup",value:function(e){var t=e.size||this.options.markupSize||40,i=this.markups.length,r=Object.assign({},{initialFragPos:this.getFragmentPos(e.fragId),color:new THREE.Vector4(1,0,0,1),name:"Markup "+(i+1),id:this.guid("xxx-xxx-xxx"),__visible:!0,occlusion:!0,visible:!0,size:t},e,{index:i}),n=this.geometry.vertices[r.index];return n.x=r.point.x,n.y=r.point.y,n.z=r.point.z,this.geometry.verticesNeedUpdate=!0,this.markups.push(r),this.setMarkupSize(r.id,r.size),this.updateMarkup(r),this.setMarkupColor(r.id,this.runAnimation?r.color:new THREE.Vector4(0,0,0,0),!this.runAnimation),this.emit("markup.created",r),r}},{key:"removeMarkup",value:function(e){var t=this,i=this.pointCloud.material.attributes.pointSize;this.markups=this.markups.filter(function(t){return t.id!==e}),this.markups.forEach(function(e,r){var n=t.geometry.vertices[r];i.value[r]=e.size,n.x=e.point.x,n.y=e.point.y,n.z=e.point.z,e.index=r,t.updateMarkup(e)});for(var r=this.markups.length;r<this.geometry.vertices.length;++r)i.value[r]=0;this.geometry.verticesNeedUpdate=!0,i.needsUpdate=!0,this.viewer.impl.invalidate(!0),this.emit("markup.deleted",e)}},{key:"clearMarkups",value:function(){for(var e=this.pointCloud.material.attributes.pointSize,t=this.geometry.vertices.length,i=0;i<t;++i)e.value[i]=0;e.needsUpdate=!0,this.viewer.impl.invalidate(!0),this.markups=[]}},{key:"setMarkupPosition",value:function(e,t){var i=this.getMarkupById(e),r=this.geometry.vertices[i.index];r.x=t.x,r.y=t.y,r.z=t.z,this.geometry.verticesNeedUpdate=!0}},{key:"setMarkupData",value:function(e,t){var i=this.getMarkupById(e);Object.assign(i,t)}},{key:"setMarkupVisibility",value:function(e,t){var i=this.getMarkupById(e);i.visible=t,this.updateMarkup(i)}},{key:"__setMarkupVisibility",value:function(e,t){var i=this.getMarkupById(e);i.__visible=t,this.updateMarkup(i)}},{key:"setMarkupOcclusion",value:function(e,t){var i=this.getMarkupById(e);i.occlusion=t,this.updateMarkup(i)}},{key:"updateMarkup",value:function(e){if(e.visible&&e.__visible)if(e.occlusion){var t=this.checkOcclusion(e);this.setMarkupSize(e.id,t?0:e.size,!0)}else this.setMarkupSize(e.id,e.size,!0);else this.setMarkupSize(e.id,0,!0)}},{key:"getState",value:function(){return{markups:this.markups}}},{key:"restoreState",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.clearMarkups(),t.markups&&t.markups.forEach(function(t){e.addMarkup(t)})}},{key:"onCameraChanged",value:function(e){var t=this;this.markups.forEach(function(e){if(e.visible&&e.__visible&&e.occlusion){var i=t.checkOcclusion(e);t.setMarkupSize(e.id,i?0:e.size,!0)}})}},{key:"onExplode",value:function(e){var t=this;this.markups.forEach(function(e){if(e.visible&&e.__visible){var i=t.getFragmentPos(e.fragId),r=e.point,n=e.initialFragPos,a={x:r.x+i.x-n.x,y:r.y+i.y-n.y,z:r.z+i.z-n.z};t.setMarkupPosition(e.id,a)}})}},{key:"onVisibility",value:function(e){var t=this;this.markups.forEach(function(i){var r=e.nodeIdArray;switch(e.type){case"isolate":r.indexOf(i.dbId)>-1||!r.length?t.__setMarkupVisibility(i.id,!0):r.length&&t.__setMarkupVisibility(i.id,!1);break;case"hide":r.indexOf(i.dbId)>-1&&t.__setMarkupVisibility(i.id,!1);break;case"show":r.indexOf(i.dbId)>-1&&t.__setMarkupVisibility(i.id,!0)}})}},{key:"pointToRaycaster",value:function(e,t,i){var r=new THREE.Vector3,n=new THREE.Vector3,a=new THREE.Raycaster;a.params.PointCloud.threshold=this.options.selectionRayThreshold||1;var s=e.getBoundingClientRect(),o=(i.x-s.left)/s.width*2-1,u=-(i.y-s.top)/s.height*2+1;return t.isPerspective?(r.set(o,u,.5),r.unproject(t),a.set(t.position,r.sub(t.position).normalize())):(r.set(o,u,-1),r.unproject(t),n.set(0,0,-1),a.set(r,n.transformDirection(t.matrixWorld))),a}},{key:"getSelection",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.options.selectionDistThreshold||1,i=this.pointToRaycaster(this.viewer.impl.canvas,this.viewer.impl.camera,{x:e.x,y:e.y}).intersectObjects([this.pointCloud],!0);return i.length?this.markups.filter(function(e){var r=i[0].point.x-e.point.x,n=i[0].point.y-e.point.y,a=i[0].point.z-e.point.z;return Math.sqrt(r*r+n*n+a*a)<t}):[]}},{key:"checkOcclusion",value:function(t){var i=this.viewer.worldToClient(t.point),r=e(this.viewer.container).offset(),n=this.pointToRaycaster(this.viewer.impl.canvas,this.viewer.impl.camera,{x:i.x+r.left,y:i.y+r.top}),a=this.viewer.model.rayIntersect(n,!0,this.dbIds);if(a){if(a.fragId===t.fragId){var s={x:a.point.x-t.point.x,y:a.point.y-t.point.y,z:a.point.z-t.point.z},o=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);if(this.options.logOcclusionDist&&console.log(o),o<this.options.occlusionDist)return!1}return!0}}},{key:"getAllDbIds",value:function(){var e=this.viewer.model.getData().instanceTree.nodeAccess.dbIdToIndex;return Object.keys(e).map(function(e){return parseInt(e)})}},{key:"destroy",value:function(){var e=this;this.viewer.impl.sceneAfter.remove(this.pointCloud),this.eventHandlers.forEach(function(t){e.viewer.removeEventListener(t.event,t.handler)}),this.runAnimation=!1,this.markups=[],this.off()}}]),i}(l.a)}).call(this,i(18))}}]);
//# sourceMappingURL=18.07867354.chunk.js.map